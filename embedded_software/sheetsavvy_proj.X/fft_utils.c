#include "fft_utils.h"

// this is the address of the twiddle factors (points to x memory)
    const int factPage = 0xFF00;  
    
//window that needs to exist for either hamming or hanning window
//extern fractional window[512];

    // twiddle factor array (const)
    fractcomplex twiddleFactors[FFT_SIZE] __attribute__ ((space(xmemory), aligned (1024*2)));// = {
//        0x7FFF, 0x0000, 0x7FFE, 0xFE6E, 0x7FF6, 0xFCDC, 0x7FEA, 0xFB4A,
//        0x7FD9, 0xF9B8, 0x7FC2, 0xF827, 0x7FA7, 0xF695, 0x7F87, 0xF505,
//        0x7F62, 0xF374, 0x7F38, 0xF1E4, 0x7F0A, 0xF055, 0x7ED6, 0xEEC6,
//        0x7E9D, 0xED38, 0x7E60, 0xEBAB, 0x7E1E, 0xEA1E, 0x7DD6, 0xE892,
//        0x7D8A, 0xE707, 0x7D3A, 0xE57D, 0x7CE4, 0xE3F4, 0x7C89, 0xE26D,
//        0x7C2A, 0xE0E6, 0x7BC6, 0xDF61, 0x7B5D, 0xDDDC, 0x7AEF, 0xDC59,
//        0x7A7D, 0xDAD8, 0x7A06, 0xD958, 0x798A, 0xD7D9, 0x790A, 0xD65C,
//        0x7885, 0xD4E1, 0x77FB, 0xD367, 0x776C, 0xD1EF, 0x76D9, 0xD079,
//        0x7642, 0xCF04, 0x75A6, 0xCD92, 0x7505, 0xCC21, 0x7460, 0xCAB2,
//        0x73B6, 0xC946, 0x7308, 0xC7DB, 0x7255, 0xC673, 0x719E, 0xC50D,
//        0x70E3, 0xC3A9, 0x7023, 0xC248, 0x6F5F, 0xC0E9, 0x6E97, 0xBF8C,
//        0x6DCA, 0xBE32, 0x6CF9, 0xBCDA, 0x6C24, 0xBB85, 0x6B4B, 0xBA33,
//        0x6A6E, 0xB8E3, 0x698C, 0xB796, 0x68A7, 0xB64C, 0x67BD, 0xB505,
//        0x66D0, 0xB3C0, 0x65DE, 0xB27F, 0x64E9, 0xB140, 0x63EF, 0xB005,
//        0x62F2, 0xAECC, 0x61F1, 0xAD97, 0x60EC, 0xAC65, 0x5FE4, 0xAB36,
//        0x5ED8, 0xAA0A, 0x5DC8, 0xA8E2, 0x5CB4, 0xA7BD, 0x5B9D, 0xA69C,
//        0x5A83, 0xA57E, 0x5964, 0xA463, 0x5843, 0xA34C, 0x571E, 0xA238,
//        0x55F6, 0xA128, 0x54CA, 0xA01C, 0x539B, 0x9F14, 0x5269, 0x9E0F,
//        0x5134, 0x9D0E, 0x4FFB, 0x9C11, 0x4EC0, 0x9B17, 0x4D81, 0x9A22,
//        0x4C40, 0x9930, 0x4AFB, 0x9843, 0x49B4, 0x9759, 0x486A, 0x9674,
//        0x471D, 0x9592, 0x45CD, 0x94B5, 0x447B, 0x93DC, 0x4326, 0x9307,
//        0x41CE, 0x9236, 0x4074, 0x9169, 0x3F17, 0x90A1, 0x3DB8, 0x8FDD,
//        0x3C57, 0x8F1D, 0x3AF3, 0x8E62, 0x398D, 0x8DAB, 0x3825, 0x8CF8,
//        0x36BA, 0x8C4A, 0x354E, 0x8BA0, 0x33DF, 0x8AFB, 0x326E, 0x8A5A,
//        0x30FC, 0x89BE, 0x2F87, 0x8927, 0x2E11, 0x8894, 0x2C99, 0x8805,
//        0x2B1F, 0x877B, 0x29A4, 0x86F6, 0x2827, 0x8676, 0x26A8, 0x85FA,
//        0x2528, 0x8583, 0x23A7, 0x8511, 0x2224, 0x84A3, 0x209F, 0x843A,
//        0x1F1A, 0x83D6, 0x1D93, 0x8377, 0x1C0C, 0x831C, 0x1A83, 0x82C6,
//        0x18F9, 0x8276, 0x176E, 0x822A, 0x15E2, 0x81E2, 0x1455, 0x81A0,
//        0x12C8, 0x8163, 0x113A, 0x812A, 0x0FAB, 0x80F6, 0x0E1C, 0x80C8,
//        0x0C8C, 0x809E, 0x0AFB, 0x8079, 0x096B, 0x8059, 0x07D9, 0x803E,
//        0x0648, 0x8027, 0x04B6, 0x8016, 0x0324, 0x800A, 0x0192, 0x8002,
//        0x0000, 0x8000, 0xFE6E, 0x8002, 0xFCDC, 0x800A, 0xFB4A, 0x8016,
//        0xF9B8, 0x8027, 0xF827, 0x803E, 0xF695, 0x8059, 0xF505, 0x8079,
//        0xF374, 0x809E, 0xF1E4, 0x80C8, 0xF055, 0x80F6, 0xEEC6, 0x812A,
//        0xED38, 0x8163, 0xEBAB, 0x81A0, 0xEA1E, 0x81E2, 0xE892, 0x822A,
//        0xE707, 0x8276, 0xE57D, 0x82C6, 0xE3F4, 0x831C, 0xE26D, 0x8377,
//        0xE0E6, 0x83D6, 0xDF61, 0x843A, 0xDDDC, 0x84A3, 0xDC59, 0x8511,
//        0xDAD8, 0x8583, 0xD958, 0x85FA, 0xD7D9, 0x8676, 0xD65C, 0x86F6,
//        0xD4E1, 0x877B, 0xD367, 0x8805, 0xD1EF, 0x8894, 0xD079, 0x8927,
//        0xCF04, 0x89BE, 0xCD92, 0x8A5A, 0xCC21, 0x8AFB, 0xCAB2, 0x8BA0,
//        0xC946, 0x8C4A, 0xC7DB, 0x8CF8, 0xC673, 0x8DAB, 0xC50D, 0x8E62,
//        0xC3A9, 0x8F1D, 0xC248, 0x8FDD, 0xC0E9, 0x90A1, 0xBF8C, 0x9169,
//        0xBE32, 0x9236, 0xBCDA, 0x9307, 0xBB85, 0x93DC, 0xBA33, 0x94B5,
//        0xB8E3, 0x9592, 0xB796, 0x9674, 0xB64C, 0x9759, 0xB505, 0x9843,
//        0xB3C0, 0x9930, 0xB27F, 0x9A22, 0xB140, 0x9B17, 0xB005, 0x9C11,
//        0xAECC, 0x9D0E, 0xAD97, 0x9E0F, 0xAC65, 0x9F14, 0xAB36, 0xA01C,
//        0xAA0A, 0xA128, 0xA8E2, 0xA238, 0xA7BD, 0xA34C, 0xA69C, 0xA463,
//        0xA57D, 0xA57D, 0xA463, 0xA69C, 0xA34C, 0xA7BD, 0xA238, 0xA8E2,
//        0xA128, 0xAA0A, 0xA01C, 0xAB36, 0x9F14, 0xAC65, 0x9E0F, 0xAD97,
//        0x9D0E, 0xAECC, 0x9C11, 0xB005, 0x9B17, 0xB140, 0x9A22, 0xB27F,
//        0x9930, 0xB3C0, 0x9843, 0xB504, 0x9759, 0xB64C, 0x9674, 0xB796,
//        0x9592, 0xB8E3, 0x94B5, 0xBA33, 0x93DC, 0xBB85, 0x9307, 0xBCDA,
//        0x9236, 0xBE32, 0x9169, 0xBF8C, 0x90A1, 0xC0E9, 0x8FDD, 0xC248,
//        0x8F1D, 0xC3A9, 0x8E62, 0xC50D, 0x8DAB, 0xC673, 0x8CF8, 0xC7DB,
//        0x8C4A, 0xC946, 0x8BA0, 0xCAB2, 0x8AFB, 0xCC21, 0x8A5A, 0xCD92,
//        0x89BE, 0xCF04, 0x8927, 0xD079, 0x8894, 0xD1EF, 0x8805, 0xD367,
//        0x877B, 0xD4E1, 0x86F6, 0xD65C, 0x8676, 0xD7D9, 0x85FA, 0xD958,
//        0x8583, 0xDAD8, 0x8510, 0xDC59, 0x84A3, 0xDDDC, 0x843A, 0xDF61,
//        0x83D6, 0xE0E6, 0x8377, 0xE26D, 0x831C, 0xE3F4, 0x82C6, 0xE57D,
//        0x8275, 0xE707, 0x8229, 0xE892, 0x81E2, 0xEA1E, 0x81A0, 0xEBAB,
//        0x8163, 0xED38, 0x812A, 0xEEC6, 0x80F6, 0xF055, 0x80C8, 0xF1E4,
//        0x809E, 0xF374, 0x8079, 0xF505, 0x8059, 0xF695, 0x803E, 0xF827,
//        0x8027, 0xF9B8, 0x8016, 0xFB4A, 0x800A, 0xFCDC, 0x8002, 0xFE6E
//    };

    // fft hardware buffer (volatile)
    fractcomplex fftBuffer[FFT_SIZE] __attribute__((space(ymemory), aligned(1024*2*2)));
    
    // real 32b fft hardware buffer (volatile)
//    long fftBufferR[FFT_SIZE] __attribute__((space(ymemory), aligned(1024*2*2)));
//
//    const long twiddleFactorsR[FFT_SIZE] __attribute__ ((space(xmemory), aligned (1024*2))) = {
//           0,13176712,26352928,39528151,52701887,65873638,79042909,92209205,105372028,118530885,
//           131685278,144834714,157978697,171116733,184248325,197372981,210490206,223599506,236700388,249792358,
//           262874923,275947592,289009871,302061269,315101295,328129457,341145265,354148230,367137861,380113669,
//           393075166,406021865,418953276,431868915,444768294,457650927,470516330,483364019,496193509,509004318,
//           521795963,534567963,547319836,560051104,572761285,585449903,598116479,610760536,623381598,635979190,
//           648552838,661102068,673626408,686125387,698598533,711045377,723465451,735858287,748223418,760560380,
//           772868706,785147934,797397602,809617249,821806413,833964638,846091463,858186435,870249095,882278992,
//           894275671,906238681,918167572,930061894,941921200,953745043,965532978,977284562,988999351,1000676905,
//           1012316784,1023918550,1035481766,1047005996,1058490808,1069935768,1081340445,1092704411,1104027237,1115308496,
//           1126547765,1137744621,1148898640,1160009405,1171076495,1182099496,1193077991,1204011567,1214899813,1225742318,
//           1236538675,1247288478,1257991320,1268646800,1279254516,1289814068,1300325060,1310787095,1321199781,1331562723,
//           1341875533,1352137822,1362349204,1372509294,1382617710,1392674072,1402678000,1412629117,1422527051,1432371426,
//           1442161874,1451898025,1461579514,1471205974,1480777044,1490292364,1499751576,1509154322,1518500250,1527789007,
//           1537020244,1546193612,1555308768,1564365367,1573363068,1582301533,1591180426,1599999411,1608758157,1617456335,
//           1626093616,1634669676,1643184191,1651636841,1660027308,1668355276,1676620432,1684822463,1692961062,1701035922,
//           1709046739,1716993211,1724875040,1732691928,1740443581,1748129707,1755750017,1763304224,1770792044,1778213194,
//           1785567396,1792854372,1800073849,1807225553,1814309216,1821324572,1828271356,1835149306,1841958164,1848697674,
//           1855367581,1861967634,1868497586,1874957189,1881346202,1887664383,1893911494,1900087301,1906191570,1912224073,
//           1918184581,1924072871,1929888720,1935631910,1941302225,1946899451,1952423377,1957873796,1963250501,1968553292,
//           1973781967,1978936331,1984016189,1989021350,1993951625,1998806829,2003586779,2008291295,2012920201,2017473321,
//           2021950484,2026351522,2030676269,2034924562,2039096241,2043191150,2047209133,2051150040,2055013723,2058800036,
//           2062508835,2066139983,2069693342,2073168777,2076566160,2079885360,2083126254,2086288720,2089372638,2092377892,
//           2095304370,2098151960,2100920556,2103610054,2106220352,2108751352,2111202959,2113575080,2115867626,2118080511,
//           2120213651,2122266967,2124240380,2126133817,2127947206,2129680480,2131333572,2132906420,2134398966,2135811153,
//           2137142927,2138394240,2139565043,2140655293,2141664948,2142593971,2143442326,2144209982,2144896910,2145503083,
//           2146028480,2146473080,2146836866,2147119825,2147321946,2147443222,2147483647,2147443222,2147321946,2147119825,
//           2146836866,2146473080,2146028480,2145503083,2144896910,2144209982,2143442326,2142593971,2141664948,2140655293,
//           2139565043,2138394240,2137142927,2135811153,2134398966,2132906420,2131333572,2129680480,2127947206,2126133817,
//           2124240380,2122266967,2120213651,2118080511,2115867626,2113575080,2111202959,2108751352,2106220352,2103610054,
//           2100920556,2098151960,2095304370,2092377892,2089372638,2086288720,2083126254,2079885360,2076566160,2073168777,
//           2069693342,2066139983,2062508835,2058800036,2055013723,2051150040,2047209133,2043191150,2039096241,2034924562,
//           2030676269,2026351522,2021950484,2017473321,2012920201,2008291295,2003586779,1998806829,1993951625,1989021350,
//           1984016189,1978936331,1973781967,1968553292,1963250501,1957873796,1952423377,1946899451,1941302225,1935631910,
//           1929888720,1924072871,1918184581,1912224073,1906191570,1900087301,1893911494,1887664383,1881346202,1874957189,
//           1868497586,1861967634,1855367581,1848697674,1841958164,1835149306,1828271356,1821324572,1814309216,1807225553,
//           1800073849,1792854372,1785567396,1778213194,1770792044,1763304224,1755750017,1748129707,1740443581,1732691928,
//           1724875040,1716993211,1709046739,1701035922,1692961062,1684822463,1676620432,1668355276,1660027308,1651636841,
//           1643184191,1634669676,1626093616,1617456335,1608758157,1599999411,1591180426,1582301533,1573363068,1564365367,
//           1555308768,1546193612,1537020244,1527789007,1518500250,1509154322,1499751576,1490292364,1480777044,1471205974,
//           1461579514,1451898025,1442161874,1432371426,1422527051,1412629117,1402678000,1392674072,1382617710,1372509294,
//           1362349204,1352137822,1341875533,1331562723,1321199781,1310787095,1300325060,1289814068,1279254516,1268646800,
//           1257991320,1247288478,1236538675,1225742318,1214899813,1204011567,1193077991,1182099496,1171076495,1160009405,
//           1148898640,1137744621,1126547765,1115308496,1104027237,1092704411,1081340445,1069935768,1058490808,1047005996,
//           1035481766,1023918550,1012316784,1000676905,988999351,977284562,965532978,953745043,941921200,930061894,
//           918167572,906238681,894275671,882278992,870249095,858186435,846091463,833964638,821806413,809617249,
//           797397602,785147934,772868706,760560380,748223418,735858287,723465451,711045377,698598533,686125387,
//           673626408,661102068,648552838,635979190,623381598,610760536,598116479,585449903,572761285,560051104,
//           547319836,534567963,521795963,509004318,496193509,483364019,470516330,457650927,444768294,431868915,
//           418953276,406021865,393075166,380113669,367137861,354148230,341145265,328129457,315101295,302061269,
//           289009871,275947592,262874923,249792358,236700388,223599506,210490206,197372981,184248325,171116733,
//           157978697,144834714,131685278,118530885,105372028,92209205,79042909,65873638,52701887,39528151,
//           26352928,13176712};//,0,-13176712,-26352928,-39528151,-52701887,-65873638,-79042909,-92209205,
//           -105372028,-118530885,-131685278,-144834714,-157978697,-171116733,-184248325,-197372981,-210490206,-223599506,
//           -236700388,-249792358,-262874923,-275947592,-289009871,-302061269,-315101295,-328129457,-341145265,-354148230,
//           -367137861,-380113669,-393075166,-406021865,-418953276,-431868915,-444768294,-457650927,-470516330,-483364019,
//           -496193509,-509004318,-521795963,-534567963,-547319836,-560051104,-572761285,-585449903,-598116479,-610760536,
//           -623381598,-635979190,-648552838,-661102068,-673626408,-686125387,-698598533,-711045377,-723465451,-735858287,
//           -748223418,-760560380,-772868706,-785147934,-797397602,-809617249,-821806413,-833964638,-846091463,-858186435,
//           -870249095,-882278992,-894275671,-906238681,-918167572,-930061894,-941921200,-953745043,-965532978,-977284562,//marker
//           -988999351,-1000676905,-1012316784,-1023918550,-1035481766,-1047005996,-1058490808,-1069935768,-1081340445,-1092704411,
//           -1104027237,-1115308496,-1126547765,-1137744621,-1148898640,-1160009405,-1171076495,-1182099496,-1193077991,-1204011567,
//           -1214899813,-1225742318,-1236538675,-1247288478,-1257991320,-1268646800,-1279254516,-1289814068,-1300325060,-1310787095,
//           -1321199781,-1331562723,-1341875533,-1352137822,-1362349204,-1372509294,-1382617710,-1392674072,-1402678000,-1412629117,
//           -1422527051,-1432371426,-1442161874,-1451898025,-1461579514,-1471205974,-1480777044,-1490292364,-1499751576,-1509154322,
//           -1518500250,-1527789007,-1537020244,-1546193612,-1555308768,-1564365367,-1573363068,-1582301533,-1591180426,-1599999411,
//           -1608758157,-1617456335,-1626093616,-1634669676,-1643184191,-1651636841,-1660027308,-1668355276,-1676620432,-1684822463,
//           -1692961062,-1701035922,-1709046739,-1716993211,-1724875040,-1732691928,-1740443581,-1748129707,-1755750017,-1763304224,
//           -1770792044,-1778213194,-1785567396,-1792854372,-1800073849,-1807225553,-1814309216,-1821324572,-1828271356,-1835149306,
//           -1841958164,-1848697674,-1855367581,-1861967634,-1868497586,-1874957189,-1881346202,-1887664383,-1893911494,-1900087301,
//           -1906191570,-1912224073,-1918184581,-1924072871,-1929888720,-1935631910,-1941302225,-1946899451,-1952423377,-1957873796,
//           -1963250501,-1968553292,-1973781967,-1978936331,-1984016189,-1989021350,-1993951625,-1998806829,-2003586779,-2008291295,
//           -2012920201,-2017473321,-2021950484,-2026351522,-2030676269,-2034924562,-2039096241,-2043191150,-2047209133,-2051150040,
//           -2055013723,-2058800036,-2062508835,-2066139983,-2069693342,-2073168777,-2076566160,-2079885360,-2083126254,-2086288720,
//           -2089372638,-2092377892,-2095304370,-2098151960,-2100920556,-2103610054,-2106220352,-2108751352,-2111202959,-2113575080,
//           -2115867626,-2118080511,-2120213651,-2122266967,-2124240380,-2126133817,-2127947206,-2129680480,-2131333572,-2132906420,
//           -2134398966,-2135811153,-2137142927,-2138394240,-2139565043,-2140655293,-2141664948,-2142593971,-2143442326,-2144209982,
//           -2144896910,-2145503083,-2146028480,-2146473080,-2146836866,-2147119825,-2147321946,-2147443222
//    };
    
//#include "fft_utils.h"
//
//
//void Hello()
//{
//    int i=0;
//    fractional squaredMagnitude[FFT_SIZE];
//    fractional fftMaxValue;
//    int16_t fftMaxValueBin;     
//    uint16_t peakFrequencyHz;
//    
//    uint16_t adc_data[FFT_SIZE];
//    uint16_t v;
//    uint16_t max = 2000;
//    uint16_t min = 0;
//    
//    for (i=0; i<512; i++) {
//        v = analog_read();
//        
//        if (v > max) { max = v; }
//    
//        // mapped_value = (original_value - fromLow) * (toHigh - toLow) / (fromHigh - fromLow) + toLow
//        // adc_data = (v - 0) * (1 - (-1)) / (max - (0)) + (-1);
//        adc_data[i] = 2*v/max - 1;
//        //        if (adc_data[i]>1) { adc_data[i] = 1; }
//    
//        fftBuffer[i].real = Q15(adc_data[i]);
//    } // crash -> PC=0x0306, normal exit -> PC=0x0238
//    
//    LATBbits.LATB11 = 0;
//    send_str("\rsampling loop complete!\n\0");
//    __delay_ms(10);
//    
//    // TODO wrap some of these calls in fft_utils.h
//    
//    //PERFORM THE FFT ON THE ENTIRE SET OF DATA
//    FFTComplexIP(9, (fractcomplex*)&fftBuffer[0], &twiddleFactors[0], 0xFF00);
//    BitReverseComplex(9,(fractcomplex*)&fftBuffer[0]);
//    SquareMagnitudeCplx(FFT_SIZE, (fractcomplex*)&fftBuffer[0], (fractional*)&squaredMagnitude[0]);
//    
//    int x = 0;
//    while (x < 3)
//    {
//      squaredMagnitude[x] = 0;
//      x++;
//    }
//    
//    //ONLY LOOK FOR THE PEAK FREQUENCY WITHIN THE DESIRED RANGE
//    // ~65Hz TO 1024Hz
//    fftMaxValue = VectorMax((FFT_SIZE/2), (fractional*)&squaredMagnitude[0], (int16_t*)&fftMaxValueBin);
//    
//    //WITH SAMPLING FREQ = 31250 -> CAN READ 61Hz - 31,188Hz
//    peakFrequencyHz = fftMaxValueBin * (SAMPLING_FREQUENCY_HZ/FFT_SIZE);
//    
//}